<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Adaptive AI Exam Portal</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <span class="icon">üéì</span>
                <span>Adaptive AI Exam Portal</span>
            </div>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/analytics">Analytics</a>
                <a href="/#about">About</a>
            </div>
        </div>
    </nav>

    <main class="container">
        <section class="hero">
            <h1>üìä Analytics Dashboard</h1>
            <p>Track student performance and get personalized recommendations</p>
        </section>

        <section class="analytics-controls">
            <div class="form-group">
                <label for="studentIdInput">Student ID</label>
                <input type="text" id="studentIdInput" class="form-control" placeholder="Enter student ID">
                <button class="btn btn-primary" onclick="loadStudentAnalytics()">Load Analytics</button>
            </div>
        </section>

        <section id="studentAnalytics" class="analytics-section hidden">
            <h2>Student Performance</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìö</div>
                    <div class="stat-content">
                        <h3 id="totalExams">5</h3>
                        <p>Total Exams</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-content">
                        <h3 id="avgScore">0%</h3>
                        <p>Average Score</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">‚è±Ô∏è</div>
                    <div class="stat-content">
                        <h3 id="avgTime">0s</h3>
                        <p>Avg Time/Question</p>
                    </div>
                </div>
            </div>

            <div class="performance-grid">
                <div class="performance-card">
                    <h3>üìà Performance by Difficulty</h3>
                    <div id="difficultyPerformance">
                        <div class="performance-bar">
                            <span class="label">Easy:</span>
                            <div class="bar"><div class="fill easy" id="easyBar"></div></div>
                            <span class="value" id="easyValue">0%</span>
                        </div>
                        <div class="performance-bar">
                            <span class="label">Medium:</span>
                            <div class="bar"><div class="fill medium" id="mediumBar"></div></div>
                            <span class="value" id="mediumValue">0%</span>
                        </div>
                        <div class="performance-bar">
                            <span class="label">Hard:</span>
                            <div class="bar"><div class="fill hard" id="hardBar"></div></div>
                            <span class="value" id="hardValue">0%</span>
                        </div>
                    </div>
                </div>

                <div class="performance-card">
                    <h3>üéØ Topic Performance</h3>
                    <div id="topicPerformance">
                        <p>No topic data available</p>
                    </div>
                </div>
            </div>

            <div class="improvement-section">
                <h3>üìä Improvement Trend</h3>
                <canvas id="improvementChart" width="600" height="200"></canvas>
            </div>
        </section>

        <section id="classAnalytics" class="analytics-section">
            <h2>Class Overview</h2>
            <button class="btn btn-secondary" onclick="loadClassAnalytics()">Load Class Analytics</button>
            <div id="classAnalyticsContent" class="hidden">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-content">
                            <h3 id="totalStudents">0</h3>
                            <p>Total Students</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìù</div>
                        <div class="stat-content">
                            <h3 id="totalClassExams">0</h3>
                            <p>Total Exams</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-content">
                            <h3 id="classAvgScore">0%</h3>
                            <p>Class Average</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // No API_BASE needed - use relative URLs
        
        async function loadStudentAnalytics() {
            const studentId = document.getElementById('studentIdInput').value.trim();
            
            if (!studentId) {
                alert('Please enter a student ID');
                return;
            }
            
            try {
                const response = await fetch(`/api/lectures/analytics/student/${studentId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load analytics');
                }
                
                const data = await response.json();
                
                // Show analytics section
                document.getElementById('studentAnalytics').classList.remove('hidden');
                
                // Update stats
                document.getElementById('totalExams').textContent = data.total_exams;
                document.getElementById('avgScore').textContent = Math.round(data.average_score) + '%';
                document.getElementById('avgTime').textContent = Math.round(data.time_per_question) + 's';
                
                // Update difficulty performance
                if (data.difficulty_performance) {
                    updateDifficultyBars(data.difficulty_performance);
                }
                
                // Update topic performance
                if (data.topic_performance && Object.keys(data.topic_performance).length > 0) {
                    updateTopicPerformance(data.topic_performance);
                }
                
                // Update improvement trend
                if (data.improvement_trend && data.improvement_trend.length > 0) {
                    drawImprovementChart(data.improvement_trend);
                }
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                alert('Error loading analytics: ' + error.message);
            }
        }
        
        function updateDifficultyBars(performance) {
            const difficulties = ['easy', 'medium', 'hard'];
            
            difficulties.forEach(diff => {
                const value = performance[diff] || 0;
                const bar = document.getElementById(`${diff}Bar`);
                const valueSpan = document.getElementById(`${diff}Value`);
                
                if (bar) bar.style.width = value + '%';
                if (valueSpan) valueSpan.textContent = Math.round(value) + '%';
            });
        }
        
        function updateTopicPerformance(topics) {
            const container = document.getElementById('topicPerformance');
            
            const html = Object.entries(topics).map(([topic, score]) => `
                <div class="performance-bar">
                    <span class="label">${topic}:</span>
                    <div class="bar">
                        <div class="fill" style="width: ${score}%; background: #4CAF50;"></div>
                    </div>
                    <span class="value">${Math.round(score)}%</span>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        function drawImprovementChart(trend) {
            const canvas = document.getElementById('improvementChart');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Simple line chart
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            const maxScore = 100;
            
            // Draw axes
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();
            
            // Draw line
            ctx.strokeStyle = '#4CAF50';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            const step = (width - 2 * padding) / (trend.length - 1);
            
            trend.forEach((score, index) => {
                const x = padding + index * step;
                const y = height - padding - (score / maxScore) * (height - 2 * padding);
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                // Draw point
                ctx.fillStyle = '#4CAF50';
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            ctx.stroke();
            
            // Draw labels
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            
            trend.forEach((score, index) => {
                const x = padding + index * step;
                ctx.fillText(`${index + 1}`, x, height - padding + 20);
            });
        }
        
        async function loadClassAnalytics() {
            try {
                const response = await fetch('/api/lectures/analytics/class/overview');
                
                if (!response.ok) {
                    throw new Error('Failed to load class analytics');
                }
                
                const data = await response.json();
                
                // Show class analytics
                document.getElementById('classAnalyticsContent').classList.remove('hidden');
                
                // Update stats
                document.getElementById('totalStudents').textContent = data.total_students;
                document.getElementById('totalClassExams').textContent = data.total_exams;
                document.getElementById('classAvgScore').textContent = Math.round(data.average_score) + '%';
                
            } catch (error) {
                console.error('Error loading class analytics:', error);
                alert('Error loading class analytics: ' + error.message);
            }
        }
    </script>
</body>
</html>